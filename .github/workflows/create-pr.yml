name: Create PR on behalf of Workflows

on:
  workflow_dispatch:
    inputs:
      REPOSITORY:
        description: 'The Ridecell repository where PR should be created, in the format Ridecell/{repo_name}'
        required: true
      REF:
        description: 'The desired branch/tag/sha to merge into main/master'
        required: true
      TITLE:
        description: 'Title for the Pull Request'
        required: true
      BODY:
        description: 'Text body for the Pull Request'
        required: false
        default: ''
      SLACK_CHANNEL:
        description: 'Slack channel to be notified of PR creation'
        required: false
        default: 'devops-eng-private'

  push:
    branches:
      - main  # You can change this to the branch where updates are made


jobs:
  create-pr:
    runs-on: ubuntu-latest
    name: Create Pull Request

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2  # This step checks out your repository's code.

    # - name: Display Workflow Inputs
    #   run: |
    #     echo '${{ toJSON(github.event.inputs) }}'

    # - name: Format inputs for postdata body
    #   id: post-body
    #   run: |
    #     # It seems although input BODY was received in JSON format (e.g. newlines escaped),
    #     # the escaped values gets converted. Hence, we need to format it to JSON again for
    #     # building our postData body in the next step.
        
    #     echo PR_BODY=${{ toJSON(inputs.BODY) }} >> $GITHUB_OUTPUT


    - name: Notify Devops of PR
      id: slack-notify
      uses: sonots/slack-notice-action@v3
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
      with:
        username: GithubActions
        status: custom
        payload: |
            {
                "channel": "#${{ inputs.SLACK_CHANNEL }}",
                "text": "New version available \nAutomated Pull Request Created",
                "blocks": [
                {
                    "type": "header",
                    "text": {
                    "type": "plain_text",
                    "text": "New version available"
                    }
                }
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "Pull Request:\n${{ inputs.TITLE }}>"
                  }
                }
              ]
            }
            