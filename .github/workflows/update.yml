
name: only Monitor Runner Releases

on:
  push:
    branches:
      - main

jobs:
  monitor-releases:
    runs-on: ubuntu-latest
    env:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Get Release Information
        id: release-info
        run: |
          chmod +x ./get_release.sh
          ./get_release.sh

      - name: Notify
        if: ${{steps.release-info.outputs.notify}} == true
        id: notify
        run: |
          notify=${{steps.release-info.outputs.notify}}
          if $notify; then
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            git checkout -b Runner-Update  # Create a new branch for the changes
            git add .
            git commit -m "Update file via GitHub Actions"

            git fetch origin main:main
            git checkout main
            git pull origin main

            git checkout Runner-Update
            git rebase main
            git push origin Runner-Update --force  # Force push to the new branch
          else
            echo "Notify value: $notify"
          fi


      - name: Create PR and Notify via Github-actions
        if: ${{steps.release-info.outputs.notify}} == true
        run: |
          postData='{
            "ref": "main",
            "inputs": {
              "REPOSITORY": "${{ github.repository }}",
              "REF": "Runner-Update",
              "TITLE": "GitHub action runner update",
              "BODY": "Current Version: ${{ env.CURRENT_VERSION }}\nLatest Release: ${{ env.latest_release }}\nPrevious Major Version: ${{ env.previous_major_version }}\nLatest Release from Previous Major: ${{ env.latest_release_previous_major }}",
              "SLACK_CHANNEL": "actions-notif"
            }
          }'
          curl -X POST \
          -d "${postData}" \
          -H "Accept: application/vnd.github+json" \
          -H "Authorization: Bearer ${{ secrets.MY_GITHUB_ACTION_TOKEN }}" \
          -H "X-GitHub-Api-Version: 2022-11-28" \
          https://api.github.com/repos/ajinkyak423/actions-poc/actions/workflows/create-pr.yml/dispatches