name: validation
on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
jobs:
   validation:
    permissions:
        id-token: write
        contents: read
        issues: write
        pull-requests: write
    runs-on: ubuntu-latest

    steps:
        - name: Checkout
          uses: actions/checkout@v4
          with:
            fetch-depth: 2

        -  name: Setup dyff diff tool
           run: |
            curl -L https://github.com/homeport/dyff/releases/download/v1.7.1/dyff_1.7.1_linux_amd64.tar.gz -o dyff.tar.gz
            tar -zxvf dyff.tar.gz
            cp dyff /usr/local/bin/dyff

            cd "$GITHUB_WORKSPACE"
            export GIT_DIR="$GITHUB_WORKSPACE/.git"
            export GIT_WORK_TREE="$GITHUB_WORKSPACE"

            git config --file "$GIT_DIR/config" diff.dyff.command 'dyff_between() { dyff --color on between --omit-header "$2" "$5"; }; dyff_between'
            echo '*.yml diff=dyff' >> .gitattributes

        -  name: Check modified files for any changes to k8s.ibm-plat-fr2-01-workload
           id: check-cluster-changes
           run: |
            # Added to slove fatal: detected dubious ownership in repository at '/__w/infra-auth/infra-auth' error.
            git config --global --add safe.directory "$GITHUB_WORKSPACE"
            git fetch origin main
            for file in $(git diff --name-only origin/main...HEAD -- '*.yml'); do
                if git diff --ext-diff origin/main...HEAD -- "$file" | grep -q 'k8s\.ibm-plat-fr2-01-workload'; then
                CHANGED=true
                break
                fi
            done

            echo "cluster_changed=$CHANGED" >> $GITHUB_OUTPUT

        -   name: Comment on PR
            if: steps.check-cluster-changes.outputs.cluster_changed == 'true' && github.event_name == 'pull_request'
            run: |
                # Find the first matching file and line number
                git fetch origin main
                FILE_LINE=$(git diff -U0 origin/main...HEAD -- '*.yml' | grep -n 'k8s\.ibm-plat-fr2-01-workload' | head -1)
                
                if [ -z "$FILE_LINE" ]; then
                echo "No matching line found."
                exit 0
                fi

                LINE_NUM=$(echo "$FILE_LINE" | cut -d':' -f1)
                LINE_CONTENT=$(echo "$FILE_LINE" | cut -d':' -f2-)
                FILE_PATH=$(git diff --name-only origin/main...HEAD -- '*.yml' | grep -F "$LINE_CONTENT" | head -1)

                # Use GitHub API to find the correct position in the diff
                POSITION=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                -H "Accept: application/vnd.github+json" \
                https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/files \
                | jq ".[] | select(.filename == \"$FILE_PATH\") | .patch" \
                | grep -n '^+' | head -1 | cut -d':' -f1)

                if [ -z "$POSITION" ]; then
                echo "Unable to determine diff position."
                exit 0
                fi

                # Post the inline resolvable comment
                COMMENT="⚠️ Detected changes involving \`ibm-plat-fr2-01-workload\`. Please verify these changes are authorized."

                curl -s -X POST \
                -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                -H "Accept: application/vnd.github+json" \
                https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/comments \
                -d @- <<EOF
                {
                "body": "$COMMENT",
                "commit_id": "${{ github.event.pull_request.head.sha }}",
                "path": "$FILE_PATH",
                "side": "RIGHT",
                "position": $POSITION
                }
                EOF